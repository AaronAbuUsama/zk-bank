# Story 1.3: Add Convex Infrastructure

**Status:** Draft

---

## User Story

As a **developer**,
I want **Convex real-time backend infrastructure set up**,
So that **future features can leverage real-time sync for chat, liquidations, and user data**.

---

## Acceptance Criteria

1. **AC #1:** Convex 1.25+ is installed and configured
2. **AC #2:** `bunx convex dev` starts successfully
3. **AC #3:** Convex schema defines all 5 tables (users, messages, agents, liquidations, prices)
4. **AC #4:** Convex client connects without errors when CONVEX_URL is set
5. **AC #5:** `.env.example` documents CONVEX_URL requirement
6. **AC #6:** Convex directory structure follows conventions

---

## Implementation Details

### Tasks / Subtasks

- [ ] Install Convex (AC: #1)
  - [ ] Run `bun add convex`
  - [ ] Verify version 1.25+ installed
- [ ] Initialize Convex project (AC: #2, #6)
  - [ ] Run `bunx convex init`
  - [ ] Accept default configuration
  - [ ] Verify `convex/` directory created
- [ ] Create Convex schema (AC: #3)
  - [ ] Create `convex/schema.ts`
  - [ ] Define `users` table with wallet_address, username, bio, created_at
  - [ ] Define `messages` table with user_id, agent_id, content, message_type, created_at
  - [ ] Define `agents` table with name, persona, activity_level, is_active
  - [ ] Define `liquidations` table with address, collateral_type, collateral_amount, usd_value, tx_hash, created_at
  - [ ] Define `prices` table with symbol, price_usd, change_24h, updated_at
  - [ ] Add appropriate indexes
- [ ] Create Convex client service (AC: #4)
  - [ ] Create `cli/services/convex/client.ts`
  - [ ] Implement getConvexClient() singleton
  - [ ] Handle missing CONVEX_URL gracefully
- [ ] Create re-export index
  - [ ] Create `cli/services/convex/index.ts`
- [ ] Update environment documentation (AC: #5)
  - [ ] Create or update `.env.example`
  - [ ] Document CONVEX_URL (auto-set by convex dev)
- [ ] Verify Convex dev server (AC: #2)
  - [ ] Start `bunx convex dev`
  - [ ] Verify schema syncs
  - [ ] Verify dashboard accessible

### Technical Summary

This story implements ADR-005 (Convex for Real-Time). Convex provides real-time subscriptions, serverless functions, and Bun support out of the box.

**Schema Implementation:**

```typescript
// convex/schema.ts
import { defineSchema, defineTable } from 'convex/server'
import { v } from 'convex/values'

export default defineSchema({
  users: defineTable({
    wallet_address: v.string(),
    username: v.string(),
    bio: v.optional(v.string()),
    created_at: v.number(),
  }).index('by_wallet', ['wallet_address']),

  messages: defineTable({
    user_id: v.optional(v.id('users')),
    agent_id: v.optional(v.id('agents')),
    content: v.string(),
    message_type: v.union(
      v.literal('chat'),
      v.literal('trade'),
      v.literal('liquidation')
    ),
    created_at: v.number(),
  }).index('by_created', ['created_at']),

  agents: defineTable({
    name: v.string(),
    persona: v.string(),
    activity_level: v.number(),
    is_active: v.boolean(),
  }),

  liquidations: defineTable({
    address: v.string(),
    collateral_type: v.string(),
    collateral_amount: v.string(),
    usd_value: v.number(),
    tx_hash: v.string(),
    created_at: v.number(),
  }).index('by_created', ['created_at']),

  prices: defineTable({
    symbol: v.string(),
    price_usd: v.number(),
    change_24h: v.number(),
    updated_at: v.number(),
  }).index('by_symbol', ['symbol']),
})
```

**Client Setup:**

```typescript
// cli/services/convex/client.ts
import { ConvexClient } from 'convex/browser'

let client: ConvexClient | null = null

export function getConvexClient(): ConvexClient {
  if (!client) {
    const url = process.env.CONVEX_URL
    if (!url) {
      throw new Error('CONVEX_URL not set. Run: bunx convex dev')
    }
    client = new ConvexClient(url)
  }
  return client
}
```

### Project Structure Notes

- **Files to modify:** `.env.example` (create if missing)
- **Files to create:**
  - `convex/schema.ts`
  - `convex/tsconfig.json` (auto-generated by convex init)
  - `cli/services/convex/client.ts`
  - `cli/services/convex/index.ts`
- **Expected test locations:** `cli/__tests__/services/convex/`
- **Estimated effort:** 2 story points
- **Prerequisites:** None (can run in parallel with Story 1.1)

### Key Code References

| File | Lines | Reference |
|------|-------|-----------|
| `cli/services/config/config.ts` | 1-82 | Service module pattern |
| `cli/shared/errors.ts` | 22-31 | Error handling pattern |

---

## Context References

**Tech-Spec:** [tech-spec.md](../tech-spec.md) - Primary context document containing:
- ADR-005: Convex for Real-Time rationale
- Complete schema definition
- Client setup code
- Environment configuration

**Architecture:** [architecture.md](../architecture.md) - Convex integration points

---

## Dev Agent Record

### Agent Model Used

<!-- Will be populated during dev-story execution -->

### Debug Log References

<!-- Will be populated during dev-story execution -->

### Completion Notes

<!-- Will be populated during dev-story execution -->

### Files Modified

<!-- Will be populated during dev-story execution -->

### Test Results

<!-- Will be populated during dev-story execution -->

---

## Review Notes

<!-- Will be populated during code review -->
